<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagrama de Gantt</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .tooltip {
            position: absolute;
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 10;
            font-size: 0.9em;
            color: #333;
        }

        h1 {
            text-align: center;
            font-size: 2em;
            margin-bottom: 20px;
        }

        #gantt-chart {
            display: flex;
            flex-direction: column;
            width: 80%;
            margin: 0 auto;
            border: 1px solid #200101;
            padding: 10px;
        }

        .gantt-header {
            display: flex;
            background-color: #005177;
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 10px 0;
            border-bottom: 1px solid #ccc;
        }

        .gantt-header span, .gantt-row span {
            flex: 1;
            text-align: center;
            border-right: 1px solid #ccc;
            padding: 5px;
        }

        .gantt-header span:last-child, .gantt-row span:last-child {
            border-right: none;
        }

        .gantt-row {
            display: flex;
            align-items: center;
            height: 40px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 5px;
        }

        .gantt-bar-container {
            flex: 1;
        }

        .gantt-bar {
            height: 100%;
            color: white;
            text-align: center;
            line-height: 30px;
            border-radius: 3px;
            padding: 0 5px;
        }

        .gantt-bar.iniciado {
            background-color: red;
        }

        .gantt-bar.progresando {
            background-color: yellow;
            color: black;
        }

        .gantt-bar.avanzado {
            background-color: green;
        }

        .gantt-bar.completado {
            background-color: blue;
        }

        .gantt-row:nth-child(even) {
            background-color: #f4f4f4;
        }


        /* Estilo del Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4); /* Fondo semitransparente */
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Estilo del botón "Agregar tarea" */
        #agregarTareaBtn {
            display: block;
            width: 200px;
            margin: 20px auto;
            padding: 10px;
            text-align: center;
            background-color: #527ae6;
            color: white;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #agregarTareaBtn:hover {
            background-color: #3e5f8a;
        }
        .gantt-time-axis {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            margin-top: 10px;
            border-top: 2px solid #527ae6;
            padding-top: 5px;
        }

        .gantt-months, .gantt-days {
            display: flex;
            flex-direction: row;
            font-size: 8px
        }

        .gantt-months span, .gantt-days span {
            text-align: center;
            padding: 5px;
            border-right: 1px solid #ccc;
        }

        span{
            height: 12%;
            width: 10%;
        }
        
    
    </style>
    <script>
        const nombreProyecto = "{{ nombre_proyecto }}";  // Asegúrate de que 'proyecto_id' es el valor correcto en el backend
    </script>
    
</head>
<body>

    <h1>Diagrama de Gantt para el Proyecto {{ nombre_proyecto }}</h1>

    <!-- Enlace para abrir el modal -->


<!-- Modal -->
<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="cerrarModal()">&times;</span>
        <h2>Registrar Tarea</h2>
        <form action="{{ url_for('guardar_tarea', nombre_proyecto=nombre_proyecto) }}" method="POST">
            <div class="separar"> 
                <div class="columna">
                    <label for="nombre">Nombre de la tarea:</label>
                    <input type="text" id="nombre" name="nombre" required><br>

                    <label for="proyecto">Proyecto:</label>
                    <input type="text" id="proyecto" name="proyecto" value="{{ nombre_proyecto }}" ><br>

                    <label for="fecha_inicio">Fecha de inicio:</label>
                    <input type="date" id="fecha_inicio" name="fecha_inicio" required><br>
                </div>
                <div class="columna">
                    <label for="fecha_fin">Fecha de finalización:</label>
                    <input type="date" id="fecha_fin" name="fecha_fin" required><br>

                    <label for="encargado">Encargado:</label>
                    <select name="encargado" id="encargado" required>
                        <option value="" disabled selected>Selecciona un encargado</option>
                        {% for id, nombre in encargados_dict.items() %}
                            <option value="{{ id }}">{{ nombre }}</option>
                        {% endfor %}
                    </select><br>

                    <label for="estado">Estado:</label>
                    <select id="estado" name="estado" required>
                        <option value="Iniciado">Iniciado</option>
                        <option value="Progresando">En progreso</option>
                        <option value="Avanzado">Avanzado</option>
                        <option value="Completado">Completado</option>
                    </select><br>
                </div>
            </div>
            <button type="submit">Guardar Tarea</button>
        </form>
    </div>
</div>

    <div id="gantt-chart" class="gantt-chart">
        <div class="gantt-header">
            <span>Tarea</span>
            <span>Fecha de Inicio</span>
            <span>Fecha de Fin</span>
            <span>Encargado</span>
            <span>
              
                <div class="gantt-time-axis">
                    <div id="gantt-months" class="gantt-months"></div>
                    <div id="gantt-days" class="gantt-days"></div>
                </div>
            </span>
            
        </div>
        <div id="gantt-charts" class="gantt-chart">
            <div id="gantt-chart-rows"></div>
        </div>


    {% if rol in ['super_administrador', 'administrador','empleado'] %}
    <div id="tooltip" class="tooltip"></div> <a href="#" onclick="abrirModal()">+ Añadir Tarea</a>

    <div id="tooltip" class="tooltip"></div> 
    <a href="#" onclick="exportarPDF()">+ Exportar como PDF</a>
    <div id="tooltip" class="tooltip"></div> 
    <a href="#" onclick="exportarXLSX()">+ Exportar como XLSX o Excel</a>
    {% endif %}
    <script>
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const day = date.getUTCDate().toString().padStart(2, '0');
            const month = (date.getUTCMonth() + 1).toString().padStart(2, '0');
            const year = date.getUTCFullYear();
            return `${day}/${month}/${year}`;
        }

        async function cargarTareas() {
    try {
        // Usar nombreProyecto, que está definido desde el backend
        const response = await fetch('/tareas/' + nombreProyecto);
        const tareas = await response.json();

        const chart = document.getElementById('gantt-chart-rows');
        const fechaMin = new Date(Math.min(...tareas.map(t => new Date(t.fecha_inicio))));
        const fechaMax = new Date(Math.max(...tareas.map(t => new Date(t.fecha_fin))));

        tareas.forEach(tarea => {
            const row = document.createElement('div');
            row.classList.add('gantt-row');

            const taskName = document.createElement('span');
            taskName.textContent = tarea.nombre;

            const taskStart = document.createElement('span');
            taskStart.textContent = formatDate(tarea.fecha_inicio);

            const taskEnd = document.createElement('span');
            taskEnd.textContent = formatDate(tarea.fecha_fin);

            const taskOwner = document.createElement('span');
            taskOwner.textContent = tarea.encargado;

            const barContainer = document.createElement('span');
            barContainer.classList.add('gantt-bar-container');
            const bar = document.createElement('div');
            bar.classList.add('gantt-bar');
           

            // Configuración de la barra de tarea
            const fechaInicio = new Date(tarea.fecha_inicio);
            const fechaFin = new Date(tarea.fecha_fin);
            const duracion = (fechaFin - fechaInicio) / (1000 * 60 * 60 * 24);
            const offset = ((fechaInicio - fechaMin) / (1000 * 60 * 60 * 24)) * 20;

            bar.style.width = duracion * 20 + 'px';
            bar.style.marginLeft = offset + 'px';

            // Color según el estado
            switch (tarea.estado.trim().toLowerCase()) {
                case 'iniciado':
                    bar.classList.add('iniciado');
                    break;
                case 'progresando':
                    bar.classList.add('progresando');
                    break;
                case 'avanzado':
                    bar.classList.add('avanzado');
                    break;
                case 'completado':
                    bar.classList.add('completado');
                    break;
                default:
                    bar.style.backgroundColor = '#ccc';
            }

            // Evento para mostrar el tooltip
            bar.addEventListener('mouseover', function (event) {
                mostrarTooltip(event, tarea);
            });

            // Evento para ocultar el tooltip
            bar.addEventListener('mouseout', ocultarTooltip);

            barContainer.appendChild(bar);
            row.appendChild(taskName);
            row.appendChild(taskStart);
            row.appendChild(taskEnd);
            row.appendChild(taskOwner);
            row.appendChild(barContainer);

            chart.appendChild(row);
        });

        generarEjeTemporal(fechaMin, fechaMax);

    } catch (error) {
        console.error("Error cargando las tareas:", error);
    }
}

        function abrirModal() {
    document.getElementById("modal").style.display = "flex";
}

// Función para cerrar el modal
function cerrarModal() {
    document.getElementById("modal").style.display = "none";
}
        function generarEjeTemporal(fechaInicio, fechaFin) {
    const monthsContainer = document.getElementById('gantt-months');
    const daysContainer = document.getElementById('gantt-days');
    
    // Limpiamos los contenedores de meses y días para regenerar el contenido
    monthsContainer.innerHTML = '';
    daysContainer.innerHTML = '';

    let currentMonth = fechaInicio.getMonth();
    let monthSpan = document.createElement('span');
    monthSpan.textContent = new Intl.DateTimeFormat('es', { month: 'long' }).format(fechaInicio);
    monthsContainer.appendChild(monthSpan);

    let daysInMonth = 0;
    let currentDate = new Date(fechaInicio);

    // Generar días dentro del rango
    while (currentDate <= fechaFin) {
        const daySpan = document.createElement('span');
        daySpan.textContent = currentDate.getDate();
        daysContainer.appendChild(daySpan);
        daysInMonth++;

        currentDate.setDate(currentDate.getDate() + 1);

        if (currentDate.getMonth() !== currentMonth || currentDate > fechaFin) {
            monthSpan.style.flex = daysInMonth;
            daysInMonth = 0;
            currentMonth = currentDate.getMonth();

            if (currentDate <= fechaFin) {
                monthSpan = document.createElement('span');
                monthSpan.textContent = new Intl.DateTimeFormat('es', { month: 'long' }).format(currentDate);
                monthsContainer.appendChild(monthSpan);
            }
        }
    }

    // Agregar el día adicional (el día siguiente al último día de fechaFin)
    const extraDay = document.createElement('span');
    const nextDay = new Date(fechaFin);
    nextDay.setDate(fechaFin.getDate() + 1);  // Establecer al día siguiente de fechaFin
    extraDay.textContent = nextDay.getDate(); // Mostrar el siguiente día
    daysContainer.appendChild(extraDay);
}


        // Función para mostrar el tooltip
        function mostrarTooltip(event, tarea) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <strong>${tarea.nombre}</strong><br>
                <strong>Fecha de Inicio:</strong> ${formatDate(tarea.fecha_inicio)}<br>
                <strong>Fecha de Fin:</strong> ${formatDate(tarea.fecha_fin)}<br>
                <strong>Encargado:</strong> ${tarea.encargado}<br>
                <strong>Estado:</strong> ${tarea.estado}
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = event.pageX + 'px';
            tooltip.style.top = event.pageY + 'px';
        }

        // Función para ocultar el tooltip
        function ocultarTooltip() {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.display = 'none';
        }

        window.onload = function() {
    cargarTareas();
};

    </script>
</body>
</html>